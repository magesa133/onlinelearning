{% extends 'student_dashboard.html' %}

{% block content %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Join Online Session</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://unpkg.com/@zegocloud/zego-uikit-prebuilt/zego-uikit-prebuilt.js"></script>
    <style>
        #root {
            width: 100%;
            height: 100%;
            position: relative;
        }
        .session-message {
            font-size: 18px;
            margin: 20px 0;
            color: #ff0000;
        }
        .session-ended-message {
            font-size: 18px;
            margin: 20px 0;
            color: #ffa500;
        }
    </style>
</head>

<div class="main-content">
    <h2 id="sessionTitle">Join Online Session</h2>
    <p>Current Room ID: <span id="currentRoomID">{{ session.room_id }}</span></p>
    <label for="roomIDInput">Enter Room ID:</label>
    <input type="text" id="roomIDInput" value="{{ session.room_id }}" readonly>

    <button id="joinSessionButton" onclick="joinSession()">Join Session</button>
    <button class="fullscreen-button" onclick="toggleFullScreen()">Toggle Fullscreen</button>

    <div id="sessionStatusMessage" class="session-message"></div>
    <div id="sessionEndedMessage" class="session-ended-message" style="display:none;"></div>

    <div id="root"></div>
</div>

<script>
    function copyRoomID() {
        const roomID = document.getElementById('currentRoomID').textContent;
        if (roomID && roomID !== "Loading..." && roomID !== "Room ID not found") {
            navigator.clipboard.writeText(roomID).then(() => {
                alert('Room ID copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy Room ID:', err);
                alert('Failed to copy Room ID. Please try manually.');
            });
        } else {
            alert('Room ID is not available to copy.');
        }
    }

    function initializeSession(roomID) {
        const userID = Math.floor(Math.random() * 10000).toString();
        const userName = "{{ username }}";
        const appID = 1271126531; 
        const serverSecret = "5261b8e7778bf38bbe00c844ca26b988"; 
        const kitToken = ZegoUIKitPrebuilt.generateKitTokenForTest(appID, serverSecret, roomID, userID, userName);

        const zp = ZegoUIKitPrebuilt.create(kitToken);
        zp.joinRoom({
            container: document.querySelector("#root"),
            scenario: { mode: ZegoUIKitPrebuilt.VideoConference },
        }).then(() => {
            console.log('Successfully joined the room');
        }).catch((error) => {
            console.error('Failed to join the room:', error);
            alert('Failed to join the room. Please check the Room ID or try again later.');
        });
    }

    async function joinSession() {
        const roomID = document.getElementById('roomIDInput').value.trim();
        const joinButton = document.getElementById('joinSessionButton');
        const sessionStatusMessage = document.getElementById('sessionStatusMessage');
        const sessionEndedMessage = document.getElementById('sessionEndedMessage');
        
        if (!roomID) {
            alert("Please enter a valid Room ID.");
            return;
        }

        try {
            const sessionData = await fetch(`/get_session_data/${roomID}`);
            const data = await sessionData.json();

            const currentTime = new Date();
            const startTime = new Date(data.startTime);
            const endTime = new Date(data.endTime);

            if (currentTime < startTime) {
                sessionStatusMessage.textContent = `Session has not started yet. It will start at ${startTime.toLocaleString()}.`;
                joinButton.disabled = true;
            } else if (currentTime > endTime) {
                sessionStatusMessage.textContent = `Session has ended. The session was scheduled to end at ${endTime.toLocaleString()}.`;
                sessionEndedMessage.textContent = `This session is expired.`;
                sessionEndedMessage.style.display = 'block';
                joinButton.disabled = true;
            } else if (currentTime >= startTime && currentTime <= endTime) {
                sessionStatusMessage.textContent = '';
                joinButton.disabled = false;
                initializeSession(roomID);
                sessionEndedMessage.style.display = 'none';
            }
        } catch (error) {
            console.error('Error fetching session data:', error);
            alert('An error occurred while retrieving session data. Please try again later.');
        }
    }

    function toggleFullScreen() {
        const elem = document.querySelector("#root");
        if (!document.fullscreenElement) {
            elem.requestFullscreen().catch(err => {
                console.warn(`Error attempting to enable full-screen mode: ${err.message}`);
            });
        } else {
            document.exitFullscreen();
        }
    }

    window.onload = () => {
        const roomID = document.getElementById('roomIDInput').value.trim();
        if (roomID) {
            joinSession();
        } else {
            console.error("Room ID is not available on load.");
        }
    };
</script>
{% endblock %}
